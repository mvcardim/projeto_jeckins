# ============================================
# SonarQube - Configuração LAB Simplificada
# ============================================

deploymentType: "StatefulSet"
replicaCount: 1
revisionHistoryLimit: 10

# Configuração Community Build
community:
  enabled: true

image:
  repository: sonarqube
  tag: 10.5.1-community
  pullPolicy: IfNotPresent

securityContext:
  fsGroup: 0

containerSecurityContext:
  allowPrivilegeEscalation: false
  runAsNonRoot: true
  runAsUser: 1000
  runAsGroup: 0
  seccompProfile:
    type: RuntimeDefault
  capabilities:
    drop: ["ALL"]

elasticsearch:
  bootstrapChecks: true

service:
  type: ClusterIP
  externalPort: 9000
  internalPort: 9000

# ======================================================
# PostgreSQL INTEGRADO (habilitado para LAB)
# ======================================================
postgresql:
  enabled: true
  auth:
    username: sonarUser
    password: sonarPass
    database: sonarDB
  primary:
    persistence:
      enabled: true
      size: 5Gi
    resources:
      requests:
        memory: 256Mi
        cpu: 250m
      limits:
        memory: 512Mi
        cpu: 500m

# ======================================================
# Configuração de conexão JDBC (aponta para PostgreSQL interno)
# ======================================================
jdbcOverwrite:
  enable: true
  jdbcUrl: "jdbc:postgresql://sonarqube-postgresql:5432/sonarDB"
  jdbcUsername: "sonarUser"
  jdbcPassword: "sonarPass"

# ======================================================
# Persistência do SonarQube
# ======================================================
persistence:
  enabled: true
  storageClass: ""
  accessMode: ReadWriteOnce
  size: 10Gi

# Volumes adicionais para extensões e plugins
sonarqubeFolder: /opt/sonarqube
sonarWebContext: ""

# ======================================================
# Recursos
# ======================================================
resources:
  limits:
    cpu: 2000m
    memory: 4Gi
  requests:
    cpu: 500m
    memory: 2Gi

# JVM options
jvmOpts: "-Xmx3072m -Xms1024m"
jvmCeOpts: "-Xmx512m -Xms128m"

# ======================================================
# Ingress (para acesso via nginx-ingress)
# ======================================================
ingress:
  enabled: true
  ingressClassName: nginx
  annotations: {}
  hosts:
    - name: sonarqube.localhost.com
      path: /
      pathType: Prefix
  tls: []

# ======================================================
# Nginx desabilitado (usaremos ingress)
# ======================================================
nginx:
  enabled: false

# ======================================================
# Health Checks
# ======================================================
startupProbe:
  initialDelaySeconds: 30
  periodSeconds: 10
  failureThreshold: 24
  timeoutSeconds: 1

livenessProbe:
  initialDelaySeconds: 60
  periodSeconds: 30
  failureThreshold: 6
  timeoutSeconds: 1

readinessProbe:
  initialDelaySeconds: 60
  periodSeconds: 30
  failureThreshold: 6
  timeoutSeconds: 1

terminationGracePeriodSeconds: 60

# ======================================================
# Configurações adicionais
# ======================================================

# Monitoring passcode (obrigatório)
monitoringPasscode: "define_monitoring_password"

prometheusExporter:
  enabled: false

tests:
  enabled: false

serviceAccount:
  create: false

# Plugins (opcional)
plugins:
  install: []
  # - "https://github.com/repo/plugin.jar"

# Environment variables extras
extraEnv: []

# Init containers extras
extraInitContainers: []
